{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 6{% endblock %}

{% block main %}
    <h1>–ê—Ä–µ–Ω–¥–∞ –æ—Ñ–∏—Å–æ–≤</h1>
    
    {% if login %}
        <p>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong>{{ login }}</strong></p>
        <a href="/lab5/logout">–í—ã–π—Ç–∏</a>
        
        {% if total_cost > 0 %}
            <div style="margin: 15px 0; padding: 15px; background: #e8f4f8; border-radius: 5px; border-left: 4px solid #3498db;">
                <h3>üí∞ –í–∞—à–∏ —Ç–µ–∫—É—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –∞—Ä–µ–Ω–¥—É:</h3>
                <p style="font-size: 1.2em; font-weight: bold; color: #2c3e50;">
                    –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {{ total_cost }} —Ä—É–±./–º–µ—Å.
                </p>
            </div>
        {% endif %}
    {% else %}
        <p>–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ñ–∏—Å–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ <a href="/lab5/login">–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</a></p>
    {% endif %}

    <h2>–°–ø–∏—Å–æ–∫ –∫–∞–±–∏–Ω–µ—Ç–æ–≤</h2>
    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –æ—Ñ–∏—Å–æ–≤...</div>
    <ul id="office-list" style="list-style: none; padding: 0;"></ul>
    <div id="error-message" style="color: red; display: none;"></div>

    <div id="total-cost-display" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; display: none;">
        <h3>üí∞ –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤–∞—à–µ–π –∞—Ä–µ–Ω–¥—ã:</h3>
        <p id="total-cost-text" style="font-size: 1.2em; font-weight: bold; color: #2c3e50;"></p>
    </div>
{% endblock %}

{% block script %}
<script>
    function getOfficeList() {
        const url = '/lab6/json-rpc-api/';
        const json = {
            'jsonrpc': '2.0',
            'method': 'info',
            'id': Math.round(Math.random() * 1000)
        };

        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(json)
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            const officeList = document.getElementById('office-list');
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const totalCostDisplay = document.getElementById('total-cost-display');
            const totalCostText = document.getElementById('total-cost-text');
            
            loading.style.display = 'none';
            errorMessage.style.display = 'none';
            errorMessage.textContent = '';
            
            if (data.error) {
                errorMessage.textContent = '–û—à–∏–±–∫–∞: ' + data.error.message;
                errorMessage.style.display = 'block';
                return;
            }

            if (data.result) {
                officeList.innerHTML = '';
                let userTotalCost = 0;
                const userLogin = '{{ login }}';
                
                data.result.forEach(function(office) {
                    const li = document.createElement('li');
                    li.style.margin = '10px 0';
                    li.style.padding = '15px';
                    li.style.border = '1px solid #ddd';
                    li.style.borderRadius = '5px';
                    li.style.backgroundColor = '#f9f9f9';
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (office.tenant === userLogin) {
                        userTotalCost += office.price;
                    }
                    
                    let statusText = office.tenant ? 
                        `<span style="color: #e74c3c;">–ê—Ä–µ–Ω–¥–æ–≤–∞–Ω: ${office.tenant}</span>` : 
                        '<span style="color: #27ae60;">–°–≤–æ–±–æ–¥–µ–Ω</span>';
                    
                    let buttons = '';
                    if (!office.tenant) {
                        // –°–≤–æ–±–æ–¥–Ω—ã–π –æ—Ñ–∏—Å - –∫–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                        buttons = `
                            <button onclick="booking(${office.number})" 
                                style="margin-left: 10px; padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                            </button>`;
                    } else if (office.tenant === userLogin) {
                        // –û—Ñ–∏—Å –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º - –∫–Ω–æ–ø–∫–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
                        buttons = `
                            <button onclick="cancellation(${office.number})" 
                                style="margin-left: 10px; padding: 8px 15px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                –û—Å–≤–æ–±–æ–¥–∏—Ç—å
                            </button>`;
                    } else {
                        // –û—Ñ–∏—Å –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º - –Ω–µ—Ç –∫–Ω–æ–ø–æ–∫
                        buttons = `<span style="margin-left: 10px; color: #7f8c8d;">(–∑–∞–Ω—è—Ç–æ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)</span>`;
                    }
                    
                    li.innerHTML = `
                        <strong>–ö–∞–±–∏–Ω–µ—Ç ‚Ññ${office.number}</strong> - ${statusText}
                        <br>
                        <span style="color: #2c3e50; font-weight: bold;">üíµ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${office.price} —Ä—É–±./–º–µ—Å.</span>
                        ${buttons}
                    `;
                    officeList.appendChild(li);
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏ –µ—Å—Ç—å –∞—Ä–µ–Ω–¥–∞
                if (userLogin && userTotalCost > 0) {
                    totalCostText.textContent = `–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${userTotalCost} —Ä—É–±./–º–µ—Å.`;
                    totalCostDisplay.style.display = 'block';
                } else {
                    totalCostDisplay.style.display = 'none';
                }
            }
        })
        .catch(function(error) {
            const errorMessage = document.getElementById('error-message');
            const loading = document.getElementById('loading');
            
            loading.style.display = 'none';
            errorMessage.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message;
            errorMessage.style.display = 'block';
        });
    }

    function booking(officeNumber) {
        const url = '/lab6/json-rpc-api/';
        const json = {
            'jsonrpc': '2.0',
            'method': 'booking',
            'params': officeNumber,
            'id': Math.round(Math.random() * 1000)
        };

        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(json)
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.error) {
                switch(data.error.code) {
                    case 1:
                        alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å');
                        break;
                    case 2:
                        alert('–û—Ñ–∏—Å —É–∂–µ –∞—Ä–µ–Ω–¥—É–µ—Ç—Å—è');
                        break;
                    case 3:
                        alert('–û—Ñ–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        break;
                    default:
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + data.error.message);
                }
            } else {
                // –£—Å–ø–µ—à–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                getOfficeList();
            }
        })
        .catch(function(error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏: ' + error.message);
        });
    }

    function cancellation(officeNumber) {
        const url = '/lab6/json-rpc-api/';
        const json = {
            'jsonrpc': '2.0',
            'method': 'cancellation',
            'params': officeNumber,
            'id': Math.round(Math.random() * 1000)
        };

        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(json)
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.error) {
                switch(data.error.code) {
                    case 1:
                        alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã');
                        break;
                    case 4:
                        alert('–≠—Ç–æ –Ω–µ –≤–∞—à–∞ –±—Ä–æ–Ω—å');
                        break;
                    case 5:
                        alert('–û—Ñ–∏—Å –Ω–µ –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω');
                        break;
                    case 3:
                        alert('–û—Ñ–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        break;
                    default:
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + data.error.message);
                }
            } else {
                // –£—Å–ø–µ—à–Ω–æ–µ —Å–Ω—è—Ç–∏–µ –∞—Ä–µ–Ω–¥—ã - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                getOfficeList();
                alert('–û—Ñ–∏—Å —É—Å–ø–µ—à–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω!');
            }
        })
        .catch(function(error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ –æ—Ñ–∏—Å–∞: ' + error.message);
        });
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ñ–∏—Å–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        getOfficeList();
    });
</script>
{% endblock %}